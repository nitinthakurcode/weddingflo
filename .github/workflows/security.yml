name: Security Scan

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write

env:
  NODE_OPTIONS: --max_old_space_size=4096

jobs:
  # Job 1: Verify framework versions are not vulnerable
  version-check:
    name: Framework Version Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check Next.js version
        run: |
          NEXT_VERSION=$(node -p "require('./package.json').dependencies.next.replace('^', '')")
          echo "Next.js version: $NEXT_VERSION"

          # Minimum safe versions (update these as new vulnerabilities are discovered)
          MIN_NEXT_MAJOR=15
          MIN_NEXT_MINOR=5
          MIN_NEXT_PATCH=9

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$NEXT_VERSION"

          # Check if version is at least minimum required
          if [ "$MAJOR" -lt "$MIN_NEXT_MAJOR" ]; then
            echo "::error::Next.js version $NEXT_VERSION is below minimum safe version $MIN_NEXT_MAJOR.$MIN_NEXT_MINOR.$MIN_NEXT_PATCH"
            exit 1
          elif [ "$MAJOR" -eq "$MIN_NEXT_MAJOR" ] && [ "$MINOR" -lt "$MIN_NEXT_MINOR" ]; then
            echo "::error::Next.js version $NEXT_VERSION is below minimum safe version $MIN_NEXT_MAJOR.$MIN_NEXT_MINOR.$MIN_NEXT_PATCH"
            exit 1
          elif [ "$MAJOR" -eq "$MIN_NEXT_MAJOR" ] && [ "$MINOR" -eq "$MIN_NEXT_MINOR" ] && [ "${PATCH:-0}" -lt "$MIN_NEXT_PATCH" ]; then
            echo "::error::Next.js version $NEXT_VERSION is below minimum safe version $MIN_NEXT_MAJOR.$MIN_NEXT_MINOR.$MIN_NEXT_PATCH"
            exit 1
          fi

          echo "Next.js version $NEXT_VERSION is safe"

      - name: Check React version
        run: |
          REACT_VERSION=$(node -p "require('./package.json').dependencies.react.replace('^', '')")
          echo "React version: $REACT_VERSION"

          # Minimum safe React 19
          MIN_REACT_MAJOR=19
          MIN_REACT_MINOR=0
          MIN_REACT_PATCH=4

          IFS='.' read -r MAJOR MINOR PATCH <<< "$REACT_VERSION"

          if [ "$MAJOR" -lt "$MIN_REACT_MAJOR" ]; then
            echo "::error::React version $REACT_VERSION is below minimum safe version $MIN_REACT_MAJOR.$MIN_REACT_MINOR.$MIN_REACT_PATCH"
            exit 1
          fi

          echo "React version $REACT_VERSION is safe"

      - name: Check BetterAuth version
        run: |
          BETTER_AUTH_VERSION=$(node -p "require('./package.json').dependencies['better-auth'].replace('^', '')")
          echo "BetterAuth version: $BETTER_AUTH_VERSION"

          # Minimum safe version
          MIN_VERSION="1.3.26"

          # Simple string comparison (works for semver)
          if [ "$(printf '%s\n' "$MIN_VERSION" "$BETTER_AUTH_VERSION" | sort -V | head -n1)" != "$MIN_VERSION" ]; then
            echo "::error::BetterAuth version $BETTER_AUTH_VERSION is below minimum safe version $MIN_VERSION"
            exit 1
          fi

          echo "BetterAuth version $BETTER_AUTH_VERSION is safe"

  # Job 2: npm audit for dependency vulnerabilities
  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: false

  # Job 3: Semgrep SAST scanning
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config p/typescript \
            --config p/owasp-top-ten \
            --config p/nextjs \
            --config p/security-audit \
            --sarif \
            --output semgrep-results.sarif \
            --error \
            --severity ERROR
        env:
          SEMGREP_RULES: p/typescript p/owasp-top-ten p/nextjs p/security-audit

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif

  # Job 4: TruffleHog secret detection
  secrets-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # Job 5: TypeScript type checking
  type-check:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

  # Job 6: License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          # List all licenses
          license-checker --summary

          # Fail on GPL, AGPL, or other copyleft licenses in production deps
          # Allow common permissive licenses
          license-checker --production --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;CC0-1.0;CC-BY-3.0;CC-BY-4.0;Unlicense;0BSD;BlueOak-1.0.0;Python-2.0"

  # Job 7: OWASP Dependency Check
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate package-lock.json
        run: npm install --package-lock-only

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'weddingflo'
          path: '.'
          format: 'SARIF'
          out: 'reports'
          args: >
            --enableExperimental
            --nodePackageSkipDevDependencies
            --failOnCVSS 7

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/dependency-check-report.sarif

  # Final job: Ensure all security checks passed
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [version-check, npm-audit, semgrep, secrets-scan, type-check, license-check]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          if [ "${{ needs.version-check.result }}" != "success" ] || \
             [ "${{ needs.npm-audit.result }}" != "success" ] || \
             [ "${{ needs.semgrep.result }}" != "success" ] || \
             [ "${{ needs.secrets-scan.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.license-check.result }}" != "success" ]; then
            echo "::error::One or more security scans failed"
            exit 1
          fi
          echo "All security scans passed!"
