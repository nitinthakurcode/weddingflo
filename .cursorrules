# WeddingFlow Pro - Cursor AI Rules
# Auto-loaded on every Cursor session
# Last Updated: October 23, 2025

## ğŸ¯ MANDATORY RULES - ENFORCE ON EVERY CODE CHANGE

### 1. SESSION CLAIMS FOR AUTH (NO DATABASE)
- âœ… ALWAYS use `sessionClaims.metadata.role` for role checks
- âœ… ALWAYS use `sessionClaims.metadata.company_id` for company ID
- âŒ NEVER query database for role, company_id, or auth data
- âŒ NEVER add database queries to middleware for auth
- âŒ NEVER add database queries to layouts for auth
- Target: <5ms auth performance (session claims only)

### 2. OCTOBER 2025 SUPABASE API STANDARDS
- âœ… ALWAYS use `@supabase/supabase-js` package
- âœ… ALWAYS use `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` env var
- âœ… ALWAYS use `SUPABASE_SECRET_KEY` for admin operations
- âŒ NEVER use `@supabase/ssr` package
- âŒ NEVER use `SUPABASE_ANON_KEY` (deprecated)
- âŒ NEVER use JWT templates (use default Clerk JWT)
- âŒ NEVER make `createServerSupabaseClient()` async

### 3. MINIMAL MIDDLEWARE PATTERN
- âœ… ONLY JWT verification in middleware
- âŒ NO database queries in middleware
- âŒ NO role checks in middleware (do in layouts)
- âŒ NO Supabase client creation in middleware
- Target: <1ms middleware execution

### 4. PROFESSIONAL STANDARDS
- âœ… NEVER use `any` type (use `unknown` if needed)
- âœ… ALWAYS use Zod for input validation
- âœ… ALWAYS use comprehensive error handling (TRPCError)
- âœ… ALWAYS use generated database types
- âœ… ALWAYS read migration files before database code
- âŒ NO band-aid code or "TODO: fix later"
- âŒ NO assumptions about database schema

### 5. DUAL SYNC PATTERN (WEBHOOKS)
- âœ… ALWAYS update BOTH Supabase AND Clerk metadata
- âŒ NEVER update only Supabase (session claims won't work)
- âŒ NEVER update only Clerk (database out of sync)

### 6. INCREMENTAL TESTING
- âœ… Change ONE file â†’ test â†’ next file
- âœ… Run `npm run build` after each change
- âŒ NEVER batch 10+ changes and test at the end

## ğŸš¨ RED FLAGS - REJECT CODE IMMEDIATELY

If you see ANY of these, STOP and warn user:
- Database queries in middleware
- Database queries for role/company_id in layouts
- `SUPABASE_ANON_KEY` environment variable
- `@supabase/ssr` package import
- `any` types without justification
- Missing error handling
- `localStorage` for auth tokens
- Manual JWT decoding
- JWT templates (no template exists by default)
- Making `createServerSupabaseClient` async
- Only updating Supabase OR Clerk (must update BOTH)

## ğŸ“š REFERENCE FILES - READ BEFORE CODE CHANGES

Before modifying auth, database, or core architecture:
1. `.claude/WEDDINGFLOW_PERMANENT_STANDARDS.md` - Complete standards
2. `docs/FINAL_ARCHITECTURE_AND_DEPLOYMENT_STRATEGY.md` - Architecture
3. `docs/SUPABASE_CLERK_WORKING_MODEL.md` - Supabase + Clerk integration

Use `/standards` command to load permanent standards.

## ğŸ¯ DECISION MATRIX

Before modifying working code:
1. Is it broken? NO â†’ Ask: Does user request this change?
2. Does user request it? NO â†’ Ask: Is there a concrete problem?
3. Concrete problem? NO â†’ LEAVE IT ALONE (if it works, don't touch)
4. If YES to any â†’ Ask user WHY it's needed before proceeding

## âœ… CORRECT PATTERNS (ALWAYS USE THESE)

### Session Claims:
```typescript
const { userId, sessionClaims } = await auth()
const role = sessionClaims?.metadata?.role  // âœ… Fast, <5ms
const companyId = sessionClaims?.metadata?.company_id  // âœ… No DB query
```

### Supabase Client:
```typescript
import { createClient } from '@supabase/supabase-js'  // âœ… NOT @supabase/ssr

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!  // âœ… NOT anon
)
```

### Middleware:
```typescript
export default clerkMiddleware((auth, req) => {
  if (!isPublicRoute(req)) {
    auth().protect()  // âœ… ONLY JWT verification
  }
  // âœ… NO database queries
  // âœ… NO role checking
})
```

### tRPC Error Handling:
```typescript
try {
  // Operation...
} catch (error) {
  if (error instanceof TRPCError) throw error

  throw new TRPCError({
    code: 'INTERNAL_SERVER_ERROR',
    message: 'User-friendly message',
    cause: error,
  })
}
```

## ğŸ¬ SESSION START CHECKLIST

At start of EVERY session:
1. Verify auth works (sign in â†’ dashboard loads)
2. Run `npm run build` (must show "Compiled successfully")
3. Check git status (should be clean)

If ANY fail â†’ fix FIRST before new work.

## ğŸ“ KEY LESSONS FROM HISTORY

Session 19 Disaster (Oct 18, 2025):
- Changed to JWT templates â†’ broke auth
- Switched to `@supabase/ssr` â†’ wrong package
- Made client function async â†’ broke 50+ files
- Batch changed multiple files â†’ hard to debug
- **Result:** Lost 2-3 days of work

**Lesson:** If it works, don't touch it. One change at a time. Test incrementally.

## ğŸ“Š PERFORMANCE TARGETS

- Middleware: <1ms (JWT only)
- Layout auth: <5ms (session claims)
- tRPC context: <5ms (session claims)
- Total auth overhead: <10ms
- Database auth (FORBIDDEN): 50-100ms (10-20x slower)

## âœ… COMMITMENT

As Claude Code working on WeddingFlow Pro:
- I will ALWAYS read these rules before suggesting code
- I will REJECT code that violates these patterns
- I will WARN user if their request would break standards
- I will ENFORCE October 2025 API standards
- I will NEVER compromise on production-grade quality

---
**Auto-loaded by Cursor on every session**
**Version:** 2.0 (October 23, 2025)
