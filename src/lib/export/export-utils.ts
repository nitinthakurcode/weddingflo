/**
 * Export utilities - Excel and PDF
 * Uses ExcelJS for Excel exports (secure replacement for xlsx)
 */

import ExcelJS from 'exceljs';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';

interface ExportData {
  company: {
    name: string;
    logo_url?: string;
  };
  client: {
    name: string;
    wedding_date: string;
  };
  guests: any[];
  hotels: any[];
  gifts: any[];
  transport?: any[];
  vendors: any[];
  budget: any[];
  events: any[];
  timeline: any[];
  documents: any[];
}

export async function exportToExcel(data: ExportData): Promise<ArrayBuffer> {
  const workbook = new ExcelJS.Workbook();
  workbook.creator = 'WeddingFlo';
  workbook.created = new Date();

  // Cover sheet
  const coverSheet = workbook.addWorksheet('Cover');
  coverSheet.addRow([data.company.name]);
  coverSheet.addRow([]);
  coverSheet.addRow([`Wedding: ${data.client.name}`]);
  coverSheet.addRow([`Date: ${new Date(data.client.wedding_date).toLocaleDateString()}`]);
  coverSheet.addRow([]);
  coverSheet.addRow(['Generated by WeddingFlo']);
  coverSheet.addRow([`Export Date: ${new Date().toLocaleString()}`]);

  // Style cover sheet
  coverSheet.getRow(1).font = { bold: true, size: 16 };
  coverSheet.getRow(3).font = { bold: true, size: 14 };

  // Guest List Sheet - All 15 required fields
  if (data.guests.length > 0) {
    const guestSheet = workbook.addWorksheet('Guests');
    guestSheet.columns = [
      { header: 'Serial #', key: 'serial', width: 10 },
      // 1. Guest Name
      { header: 'Guest Name', key: 'name', width: 25 },
      // 2. Phone Number
      { header: 'Phone Number', key: 'phone', width: 18 },
      // 3. Email Address
      { header: 'Email Address', key: 'email', width: 28 },
      // 4. Number of Guests
      { header: '# of Guests', key: 'partySize', width: 12 },
      // 5. Additional Guest Names
      { header: 'Additional Guests', key: 'additionalGuests', width: 35 },
      // 6. Arrival Date & Time
      { header: 'Arrival Date & Time', key: 'arrivalDatetime', width: 20 },
      // 7. Arrival Transportation
      { header: 'Arrival Transportation', key: 'arrivalMode', width: 18 },
      // 8. Departure Date & Time
      { header: 'Departure Date & Time', key: 'departureDatetime', width: 20 },
      // 9. Departure Transportation
      { header: 'Departure Transportation', key: 'departureMode', width: 18 },
      // 10. Relationship to Family
      { header: 'Relationship', key: 'relationship', width: 18 },
      // 11. Events Attending
      { header: 'Events Attending', key: 'eventsAttending', width: 30 },
      // 12. Hotel Needed (Yes/No)
      { header: 'Hotel Needed', key: 'hotelRequired', width: 15 },
      // 13. Shuttle Needed (Yes/No)
      { header: 'Shuttle Needed', key: 'transportRequired', width: 15 },
      // 14. Gift Received
      { header: 'Gift Received', key: 'giftToGive', width: 25 },
      // 15. Special Notes
      { header: 'Special Notes', key: 'notes', width: 40 },
      // Additional context fields
      { header: 'Guest Group', key: 'group', width: 18 },
      { header: 'RSVP Status', key: 'rsvp', width: 15 },
      { header: 'Dietary Needs', key: 'dietary', width: 25 },
      { header: 'Checked In', key: 'checkedIn', width: 12 },
    ];

    guestSheet.getRow(1).font = { bold: true };
    guestSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.guests.forEach((g) => {
      // Handle both snake_case and camelCase field names (for compatibility)
      const name = g.name || `${g.firstName || g.first_name || ''} ${g.lastName || g.last_name || ''}`.trim();
      const additionalNames = g.additionalGuestNames || g.additional_guest_names || [];
      const arrivalDt = g.arrivalDatetime || g.arrival_datetime;
      const departureDt = g.departureDatetime || g.departure_datetime;
      const attendingEvents = g.attendingEvents || g.attending_events || [];

      guestSheet.addRow({
        serial: g.serialNumber || g.serial_number || '',
        name: name,
        phone: g.phone || '',
        email: g.email || '',
        partySize: g.partySize || g.party_size || 1,
        additionalGuests: Array.isArray(additionalNames) ? additionalNames.join(', ') : '',
        arrivalDatetime: arrivalDt ? new Date(arrivalDt).toLocaleString() : '',
        arrivalMode: g.arrivalMode || g.arrival_mode || '',
        departureDatetime: departureDt ? new Date(departureDt).toLocaleString() : '',
        departureMode: g.departureMode || g.departure_mode || '',
        relationship: g.relationshipToFamily || g.relationship_to_family || '',
        eventsAttending: Array.isArray(attendingEvents) ? attendingEvents.join(', ') : '',
        hotelRequired: (g.hotelRequired || g.hotel_required) ? 'Yes' : 'No',
        transportRequired: (g.transportRequired || g.transport_required) ? 'Yes' : 'No',
        giftToGive: g.giftToGive || g.gift_to_give || '',
        notes: g.notes || '',
        group: g.groupName || g.group_name || g.group || '',
        rsvp: g.rsvpStatus || g.rsvp_status || 'pending',
        dietary: g.dietaryRestrictions || g.dietary_restrictions || '',
        checkedIn: (g.checkedIn || g.checked_in) ? 'Yes' : 'No',
      });
    });
  }

  // Hotels Sheet
  if (data.hotels.length > 0) {
    const hotelSheet = workbook.addWorksheet('Hotels');
    hotelSheet.columns = [
      { header: 'Guest Name', key: 'guest', width: 25 },
      { header: 'Hotel Name', key: 'hotel', width: 25 },
      { header: 'Room Number', key: 'room', width: 15 },
      { header: 'Check-In', key: 'checkIn', width: 15 },
      { header: 'Check-Out', key: 'checkOut', width: 15 },
    ];

    hotelSheet.getRow(1).font = { bold: true };
    hotelSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.hotels.forEach((h) => {
      hotelSheet.addRow({
        guest: h.guest_name,
        hotel: h.hotel_name || '',
        room: h.room_number || '',
        checkIn: h.check_in_date ? new Date(h.check_in_date).toLocaleDateString() : '',
        checkOut: h.check_out_date ? new Date(h.check_out_date).toLocaleDateString() : '',
      });
    });
  }

  // Gifts Sheet - Enhanced with delivery management fields
  if (data.gifts.length > 0) {
    const giftSheet = workbook.addWorksheet('Gifts');
    giftSheet.columns = [
      { header: 'Serial #', key: 'serial', width: 10 },
      // Guest Information
      { header: 'Guest Name', key: 'guestName', width: 25 },
      { header: 'Guest Group', key: 'guestGroup', width: 18 },
      // Gift Information
      { header: 'Gift Item', key: 'giftItem', width: 30 },
      { header: 'Gift Category', key: 'giftType', width: 20 },
      { header: 'Quantity', key: 'quantity', width: 12 },
      // Delivery Scheduling
      { header: 'Delivery Date', key: 'deliveryDate', width: 15 },
      { header: 'Delivery Time', key: 'deliveryTime', width: 15 },
      { header: 'Delivery Location', key: 'deliveryLocation', width: 30 },
      // Status & Tracking
      { header: 'Delivery Status', key: 'deliveryStatus', width: 18 },
      { header: 'Delivered By', key: 'deliveredBy', width: 20 },
      { header: 'Delivered On', key: 'deliveredAt', width: 18 },
      // Legacy fields for backwards compatibility
      { header: 'Guest Name', key: 'from', width: 25 },
      { header: 'Thank You Sent', key: 'thankYou', width: 18 },
      { header: 'Special Notes', key: 'notes', width: 40 },
    ];

    giftSheet.getRow(1).font = { bold: true };
    giftSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.gifts.forEach((g, idx) => {
      // Handle both snake_case and camelCase field names
      const guestName = g.guest_name || g.guestName ||
        (g.guest ? `${g.guest.firstName || g.guest.first_name || ''} ${g.guest.lastName || g.guest.last_name || ''}`.trim() : '');
      const guestGroup = g.guest_group || g.guestGroup || g.guest?.groupName || g.guest?.group_name || '';
      const giftItem = g.gift_item || g.giftItem || g.giftName || g.gift_name || '';
      const giftType = g.gift_type || g.giftType || g.giftTypeName || g.gift_type_name || '';
      const deliveryDate = g.delivery_date || g.deliveryDate;
      const deliveryTime = g.delivery_time || g.deliveryTime;
      const deliveryLocation = g.delivery_location || g.deliveryLocation;
      const deliveredAt = g.delivered_at || g.deliveredAt;

      giftSheet.addRow({
        serial: idx + 1,
        guestName: guestName,
        guestGroup: guestGroup,
        giftItem: giftItem,
        giftType: giftType,
        quantity: g.quantity || 1,
        deliveryDate: deliveryDate ? new Date(deliveryDate).toLocaleDateString() : '',
        deliveryTime: deliveryTime || '',
        deliveryLocation: deliveryLocation || '',
        deliveryStatus: g.delivery_status || g.deliveryStatus || 'pending',
        deliveredBy: g.delivered_by || g.deliveredBy || '',
        deliveredAt: deliveredAt ? new Date(deliveredAt).toLocaleString() : '',
        from: g.from_name || g.fromName || '',
        thankYou: (g.thank_you_sent || g.thankYouSent) ? 'Sent' : 'Pending',
        notes: g.notes || g.delivery_notes || g.deliveryNotes || '',
      });
    });
  }

  // Transport Sheet - Multi-leg journey support
  if (data.transport && data.transport.length > 0) {
    const transportSheet = workbook.addWorksheet('Transport');
    transportSheet.columns = [
      { header: 'Guest Name', key: 'guestName', width: 25 },
      { header: 'Journey Type', key: 'legType', width: 18 },
      { header: 'Trip #', key: 'legSequence', width: 10 },
      { header: 'Pickup Date', key: 'pickupDate', width: 15 },
      { header: 'Pickup Time', key: 'pickupTime', width: 12 },
      { header: 'Pickup Location', key: 'pickupFrom', width: 28 },
      { header: 'Drop-off Location', key: 'dropTo', width: 28 },
      { header: 'Status', key: 'transportStatus', width: 15 },
      { header: 'Vehicle/Shuttle', key: 'vehicleInfo', width: 25 },
      { header: 'Special Notes', key: 'notes', width: 40 },
    ];

    transportSheet.getRow(1).font = { bold: true };
    transportSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.transport.forEach((t) => {
      transportSheet.addRow({
        guestName: t.guestName || t.guest_name || '',
        legType: t.legType || t.leg_type || '',
        legSequence: t.legSequence || t.leg_sequence || 1,
        pickupDate: t.pickupDate || t.pickup_date || '',
        pickupTime: t.pickupTime || t.pickup_time || '',
        pickupFrom: t.pickupFrom || t.pickup_from || '',
        dropTo: t.dropTo || t.drop_to || '',
        transportStatus: t.transportStatus || t.transport_status || 'scheduled',
        vehicleInfo: t.vehicleInfo || t.vehicle_info || '',
        notes: t.notes || '',
      });
    });
  }

  // Vendors Sheet
  if (data.vendors.length > 0) {
    const vendorSheet = workbook.addWorksheet('Vendors');
    vendorSheet.columns = [
      { header: 'Vendor Name', key: 'vendor', width: 30 },
      { header: 'Service Category', key: 'category', width: 20 },
      { header: 'Contact Person', key: 'contact', width: 25 },
      { header: 'Phone Number', key: 'phone', width: 18 },
      { header: 'Email Address', key: 'email', width: 28 },
      { header: 'Contract Amount', key: 'cost', width: 18 },
      { header: 'Payment Status', key: 'status', width: 18 },
    ];

    vendorSheet.getRow(1).font = { bold: true };
    vendorSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.vendors.forEach((v) => {
      vendorSheet.addRow({
        vendor: v.vendor_name,
        category: v.category,
        contact: v.contact_name || '',
        phone: v.phone || '',
        email: v.email || '',
        cost: v.cost || '',
        status: v.payment_status || 'pending',
      });
    });
  }

  // Budget Sheet
  if (data.budget.length > 0) {
    const budgetSheet = workbook.addWorksheet('Budget');
    budgetSheet.columns = [
      { header: 'Category', key: 'category', width: 20 },
      { header: 'Budgeted Amount', key: 'estimated', width: 18 },
      { header: 'Actual Spent', key: 'actual', width: 18 },
      { header: 'Variance', key: 'difference', width: 15 },
      { header: 'Payment Status', key: 'status', width: 18 },
    ];

    budgetSheet.getRow(1).font = { bold: true };
    budgetSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.budget.forEach((b) => {
      budgetSheet.addRow({
        category: b.category,
        estimated: b.estimated_cost,
        actual: b.actual_cost || '-',
        difference: b.actual_cost ? b.actual_cost - b.estimated_cost : '-',
        status: b.payment_status || 'pending',
      });
    });
  }

  // Timeline Sheet
  if (data.timeline.length > 0) {
    const timelineSheet = workbook.addWorksheet('Timeline');
    timelineSheet.columns = [
      { header: 'Activity', key: 'event', width: 35 },
      { header: 'Start Time', key: 'startTime', width: 15 },
      { header: 'Duration', key: 'duration', width: 15 },
      { header: 'Location', key: 'location', width: 30 },
      { header: 'Special Notes', key: 'notes', width: 40 },
    ];

    timelineSheet.getRow(1).font = { bold: true };
    timelineSheet.getRow(1).fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE0E0E0' },
    };

    data.timeline.forEach((t) => {
      timelineSheet.addRow({
        event: t.title,
        startTime: t.start_time,
        duration: `${t.duration_minutes} min`,
        location: t.location || '',
        notes: t.notes || '',
      });
    });
  }

  // Generate buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer as ArrayBuffer;
}

export async function exportToPDF(data: ExportData): Promise<ArrayBuffer> {
  const doc = new jsPDF();

  // Header
  doc.setFontSize(20);
  doc.text(data.company.name, 15, 20);

  doc.setFontSize(16);
  doc.text(`Wedding: ${data.client.name}`, 15, 35);

  doc.setFontSize(12);
  doc.text(`Date: ${new Date(data.client.wedding_date).toLocaleDateString()}`, 15, 45);

  let yPosition = 60;

  // Guest List Table - Comprehensive view with all 15 fields
  if (data.guests.length > 0) {
    doc.setFontSize(14);
    doc.text('Guest List', 15, yPosition);
    yPosition += 10;

    // Main Guest Info Table
    autoTable(doc, {
      head: [['#', 'Name', 'Phone', 'Email', 'Party', 'Relationship', 'RSVP']],
      body: data.guests.map((g, idx) => {
        const name = g.name || `${g.firstName || g.first_name || ''} ${g.lastName || g.last_name || ''}`.trim();
        return [
          idx + 1,
          name,
          g.phone || '-',
          g.email || '-',
          g.partySize || g.party_size || 1,
          g.relationshipToFamily || g.relationship_to_family || '-',
          g.rsvpStatus || g.rsvp_status || 'pending',
        ];
      }),
      startY: yPosition,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [100, 100, 100] },
    });

    yPosition = (doc as any).lastAutoTable.finalY + 10;

    // Travel & Accommodation Summary
    if (yPosition > 200) {
      doc.addPage();
      yPosition = 20;
    }

    doc.setFontSize(12);
    doc.text('Travel & Accommodation Details', 15, yPosition);
    yPosition += 8;

    const travelData = data.guests
      .filter((g: any) => (g.arrivalDatetime || g.arrival_datetime) || (g.hotelRequired || g.hotel_required) || (g.transportRequired || g.transport_required))
      .map((g: any) => {
        const name = g.name || `${g.firstName || g.first_name || ''} ${g.lastName || g.last_name || ''}`.trim();
        const arrivalDt = g.arrivalDatetime || g.arrival_datetime;
        const departureDt = g.departureDatetime || g.departure_datetime;
        return [
          name,
          arrivalDt ? new Date(arrivalDt).toLocaleDateString() : '-',
          g.arrivalMode || g.arrival_mode || '-',
          departureDt ? new Date(departureDt).toLocaleDateString() : '-',
          (g.hotelRequired || g.hotel_required) ? '✓' : '○',
          (g.transportRequired || g.transport_required) ? '✓' : '○',
        ];
      });

    if (travelData.length > 0) {
      autoTable(doc, {
        head: [['Guest', 'Arrival', 'Mode', 'Departure', 'Hotel', 'Transport']],
        body: travelData,
        startY: yPosition,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [80, 80, 80] },
      });
      yPosition = (doc as any).lastAutoTable.finalY + 10;
    } else {
      doc.setFontSize(9);
      doc.text('No travel details recorded', 15, yPosition);
      yPosition += 10;
    }

    // Special Requirements & Gifts Summary
    if (yPosition > 230) {
      doc.addPage();
      yPosition = 20;
    }

    const specialReqs = data.guests
      .filter((g: any) => g.notes || g.giftToGive || g.gift_to_give || g.dietaryRestrictions || g.dietary_restrictions)
      .map((g: any) => {
        const name = g.name || `${g.firstName || g.first_name || ''} ${g.lastName || g.last_name || ''}`.trim();
        return [
          name,
          g.dietaryRestrictions || g.dietary_restrictions || '-',
          g.giftToGive || g.gift_to_give || '-',
          (g.notes || '').substring(0, 50) + (g.notes && g.notes.length > 50 ? '...' : ''),
        ];
      });

    if (specialReqs.length > 0) {
      doc.setFontSize(12);
      doc.text('Special Requirements & Gifts', 15, yPosition);
      yPosition += 8;

      autoTable(doc, {
        head: [['Guest', 'Dietary', 'Gift to Give', 'Notes']],
        body: specialReqs,
        startY: yPosition,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [80, 80, 80] },
      });
      yPosition = (doc as any).lastAutoTable.finalY + 15;
    }
  }

  // Budget Summary
  if (data.budget.length > 0) {
    if (yPosition > 250) {
      doc.addPage();
      yPosition = 20;
    }

    doc.setFontSize(14);
    doc.text('Budget Summary', 15, yPosition);
    yPosition += 10;

    autoTable(doc, {
      head: [['Category', 'Estimated', 'Actual', 'Status']],
      body: data.budget.map((b) => [
        b.category,
        `${b.estimated_cost}`,
        b.actual_cost ? `${b.actual_cost}` : '-',
        b.payment_status || 'pending',
      ]),
      startY: yPosition,
      styles: { fontSize: 9 },
    });

    yPosition = (doc as any).lastAutoTable.finalY + 15;
  }

  // Vendors
  if (data.vendors.length > 0) {
    if (yPosition > 250) {
      doc.addPage();
      yPosition = 20;
    }

    doc.setFontSize(14);
    doc.text('Vendors', 15, yPosition);
    yPosition += 10;

    autoTable(doc, {
      head: [['Vendor', 'Category', 'Contact', 'Cost']],
      body: data.vendors.map((v) => [
        v.vendor_name,
        v.category,
        v.contact_name || '',
        v.cost ? `${v.cost}` : '-',
      ]),
      startY: yPosition,
      styles: { fontSize: 9 },
    });
  }

  // Footer on all pages
  const pageCount = (doc as any).internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.text(
      `Page ${i} of ${pageCount} | Generated by WeddingFlo`,
      doc.internal.pageSize.width / 2,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }

  return doc.output('arraybuffer');
}
